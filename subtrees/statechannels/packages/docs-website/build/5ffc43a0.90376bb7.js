(window.webpackJsonp=window.webpackJsonp||[]).push([[142],{194:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return r})),n.d(t,"metadata",(function(){return s})),n.d(t,"rightToc",(function(){return c})),n.d(t,"default",(function(){return p}));var a=n(2),i=n(6),o=(n(0),n(420)),r={id:"deposit-assets",title:"Deposit Assets"},s={unversionedId:"protocol-tutorial/deposit-assets",id:"protocol-tutorial/deposit-assets",isDocsHomePage:!1,title:"Deposit Assets",description:'Early on in the lifecycle of a state channel -- i.e. after exchanging some setup states, but before executing any application logic -- participants will want to "fund it". They will stake assets on the channel so that the state updates are meaningful. The simplest way to do this is with an on chain deposit; a more advanced possibility is fund a new channel from an existing funded channel.',source:"@site/docs/protocol-tutorial/deposit-assets.md",permalink:"/protocol-tutorial/deposit-assets",lastUpdatedBy:"Caleb Ditchfield",lastUpdatedAt:1600126133,sidebar:"docs",previous:{title:"Execute state transitions off chain",permalink:"/protocol-tutorial/execute-state-transitions"},next:{title:"Finalize a channel (happy)",permalink:"/protocol-tutorial/finalize-a-channel-happy"}},c=[{value:"Compute a channel id",id:"compute-a-channel-id",children:[]},{value:"<code>deposit</code> into the ETH asset holder",id:"deposit-into-the-eth-asset-holder",children:[]},{value:"Destinations",id:"destinations",children:[]}],l={rightToc:c};function p(e){var t=e.components,n=Object(i.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},l,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,'Early on in the lifecycle of a state channel -- i.e. after exchanging some setup states, but before executing any application logic -- participants will want to "fund it". They will stake assets on the channel so that the state updates are meaningful. The simplest way to do this is with an on chain deposit; a more advanced possibility is fund a new channel from an existing funded channel.'),Object(o.b)("p",null,"To start, let's explore the on chain deposit case. We will need to understand how channels are uniquely identified."),Object(o.b)("h2",{id:"compute-a-channel-id"},"Compute a channel id"),Object(o.b)("p",null,"The id of a channel is the ",Object(o.b)("inlineCode",{parentName:"p"},"keccak256")," hash of the abi encoded ",Object(o.b)("inlineCode",{parentName:"p"},"chainId"),", ",Object(o.b)("inlineCode",{parentName:"p"},"participants")," and ",Object(o.b)("inlineCode",{parentName:"p"},"channelNonce"),"."),Object(o.b)("p",null,"By choosing a new ",Object(o.b)("inlineCode",{parentName:"p"},"channelNonce")," each time the same participants execute a state channel supported by the same chain, they can avoid replay attacks. The ",Object(o.b)("inlineCode",{parentName:"p"},"getChannelId")," helper exported by ",Object(o.b)("inlineCode",{parentName:"p"},"@statechannels/nitro-protocol")," accepts an object of type ",Object(o.b)("inlineCode",{parentName:"p"},"Channel")," (which contains all the necessary properties) and computes the channel id for you."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-typescript"}),"// In lesson4.test.ts\n\n// Import Ethereum utilities\nimport {Wallet} from 'ethers';\n\n// Import statechannels utilities\nimport {Channel, getChannelId} from '@statechannels/nitro-protocol';\n\nconst participants = [];\nfor (let i = 0; i < 3; i++) {\n  // As many participants as you like\n  participants[i] = Wallet.createRandom().address;\n}\n\nconst chainId = '0x1234'; // E.g. '0x1' for mainnnet. Using a mock here\n\nconst channelNonce = 0;\nconst channel: Channel = {chainId, channelNonce, participants};\nconst channelId = getChannelId(channel);\n")),Object(o.b)("h2",{id:"deposit-into-the-eth-asset-holder"},Object(o.b)("inlineCode",{parentName:"h2"},"deposit")," into the ETH asset holder"),Object(o.b)("p",null,"The deposit method allows ETH to be escrowed against a channel.\nWe have the following call signature:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-solidity"}),"function deposit(bytes32 destination, uint256 expectedHeld, uint256 amount) public payable\n")),Object(o.b)("p",null,"There are a few rules to obey when calling ",Object(o.b)("inlineCode",{parentName:"p"},"deposit"),". Firstly, ",Object(o.b)("inlineCode",{parentName:"p"},"destination")," must NOT be an ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"#destinations"}),"external destination"),". Secondly, the on-chain holdings for ",Object(o.b)("inlineCode",{parentName:"p"},"destination")," must be greater than or equal to ",Object(o.b)("inlineCode",{parentName:"p"},"expectedHeld"),". Thirdly, the holdings for ",Object(o.b)("inlineCode",{parentName:"p"},"destination")," must be less than the sum of the amount expected to be held and the amount declared in the deposit."),Object(o.b)("p",null,"The first rule prevents funds being escrowed against something other than a channelId: funds may only be unlocked from channels, so you shouldn't deposit into anything else. The second rule prevents loss of funds: since holdings are paid out in preferential order, depositing before a counterparty has deposited implies that they can withdraw your funds. The check is performed in the same transaction as the deposit, making this safe even in the event of a chain re-org that reverts a previous participant's deposit. The third rule prevents the deposit of uneccessary funds: if my aim was to increase the holdings to a certain level, but they are already at or above that level, then I want my deposit to transaction revert."),Object(o.b)("p",null,"Because we are depositing ETH, we must remember to send the right amount of ETH with the transaction. Depositing ERC20 tokens will be covered in a future tutorial."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-typescript"}),"import {ethers} from 'ethers';\nimport {randomChannelId, randomChannelId} from '@statechannels/nitro-protocol';\n\n// In lesson5.test.ts\n\n/*\n      Get an appropriate representation of 1 wei, and\n      use randomChannelId() as a dummy channelId.\n      WARNING: don't do this in the wild: you won't be able to recover these funds.\n  */\nconst amount = ethers.utils.parseUnits('1', 'wei');\nconst destination = randomChannelId();\n\n/*\n    Attempt to deposit 1 wei against the channel id we created.\n    Inspect the error message in the console for a hint about the bug on the next line \n*/\nconst expectedHeld = 0;\nconst tx0 = ETHAssetHolder.deposit(destination, expectedHeld, amount, {\n  value: amount,\n});\n")),Object(o.b)("h2",{id:"destinations"},"Destinations"),Object(o.b)("p",null,"A ",Object(o.b)("inlineCode",{parentName:"p"},"Destination")," is a ",Object(o.b)("inlineCode",{parentName:"p"},"bytes32")," and either:"),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},"A ",Object(o.b)("inlineCode",{parentName:"li"},"ChannelId")," (see the section on ",Object(o.b)("a",Object(a.a)({parentName:"li"},{href:"#compute-a-channel-id"}),"channelId"),"), or"),Object(o.b)("li",{parentName:"ol"},"An ",Object(o.b)("inlineCode",{parentName:"li"},"ExternalDestination"),", which is an ethereum address left-padded with zeros.")),Object(o.b)("div",{className:"admonition admonition-tip alert alert--success"},Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"}),Object(o.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"})))),"tip")),Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"In JavaScript, the ",Object(o.b)("inlineCode",{parentName:"p"},"ExternalDestination")," corresponding to ",Object(o.b)("inlineCode",{parentName:"p"},"address")," may be computed as"),Object(o.b)("pre",{parentName:"div"},Object(o.b)("code",Object(a.a)({parentName:"pre"},{}),"'0x' + address.padStart(64, '0')\n")),Object(o.b)("p",{parentName:"div"},"or"),Object(o.b)("pre",{parentName:"div"},Object(o.b)("code",Object(a.a)({parentName:"pre"},{}),"ethers.utils.hexZeroPad(address, 32);\n")))))}p.isMDXComponent=!0},420:function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return u}));var a=n(0),i=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=i.a.createContext({}),p=function(e){var t=i.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},d=function(e){var t=p(e.components);return i.a.createElement(l.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},b=i.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,r=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),d=p(n),b=a,u=d["".concat(r,".").concat(b)]||d[b]||h[b]||o;return n?i.a.createElement(u,s(s({ref:t},l),{},{components:n})):i.a.createElement(u,s({ref:t},l))}));function u(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,r=new Array(o);r[0]=b;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:a,r[1]=s;for(var l=2;l<o;l++)r[l]=n[l];return i.a.createElement.apply(null,r)}return i.a.createElement.apply(null,n)}b.displayName="MDXCreateElement"}}]);