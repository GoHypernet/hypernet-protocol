<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.59">
<link rel="search" type="application/opensearchdescription+xml" title="statechannels docs" href="/opensearch.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Chivo&display=swap">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css">
<script src="https://buttons.github.io/buttons.js"></script><title data-react-helmet="true">AssetHolder.sol | statechannels docs</title><meta data-react-helmet="true" property="og:image" content="https://docs.statechannels.org/img/undraw_online.svg"><meta data-react-helmet="true" property="twitter:image" content="https://docs.statechannels.org/img/undraw_online.svg"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for statechannels docs"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="AssetHolder.sol | statechannels docs"><meta data-react-helmet="true" name="description" content="The asset-holder contracts describe how ETH and/or tokens are held on-chain for any given channel, and how to interpret the channel outcomes in order to determine and execute any payouts that are due."><meta data-react-helmet="true" property="og:description" content="The asset-holder contracts describe how ETH and/or tokens are held on-chain for any given channel, and how to interpret the channel outcomes in order to determine and execute any payouts that are due."><meta data-react-helmet="true" property="og:url" content="https://docs.statechannels.org/implementation-notes/asset-holder"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="true"><link data-react-helmet="true" rel="canonical" href="https://docs.statechannels.org/implementation-notes/asset-holder"><link rel="stylesheet" href="/styles.e0b33fa7.css">
<link rel="preload" href="/styles.8e0db825.js" as="script">
<link rel="preload" href="/runtime~main.27671965.js" as="script">
<link rel="preload" href="/main.03452097.js" as="script">
<link rel="preload" href="/2.4ee922d7.js" as="script">
<link rel="preload" href="/3.4c7fc1f6.js" as="script">
<link rel="preload" href="/4.a5988223.js" as="script">
<link rel="preload" href="/1be78505.75ec5049.js" as="script">
<link rel="preload" href="/369.23cc9095.js" as="script">
<link rel="preload" href="/ec1ed54d.db84b9ba.js" as="script">
<link rel="preload" href="/17896441.61fde53e.js" as="script">
<link rel="preload" href="/69846863.53cf0c25.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg"><strong class="navbar__title">statechannels docs</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Docs</a><a class="navbar__item navbar__link" href="/typescript-api/index">Typescript API</a><a class="navbar__item navbar__link" href="/contract-api/contract-inheritance">Contract API</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span><span class="DocSearch-Button-Key">âŒ˜</span><span class="DocSearch-Button-Key">K</span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg"><strong class="navbar__title">statechannels docs</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/typescript-api/index">Typescript API</a></li><li class="menu__list-item"><a class="menu__link" href="/contract-api/contract-inheritance">Contract API</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Overview</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/">statechannels docs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/products">Our products</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">App Developers</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/app-devs/app-devs-intro">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/app-devs/quick-start-contracts">Quick start (contracts)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/app-devs/quick-start-dapp">Quick start (Dapp)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/app-devs/hook-up-messaging">Hook up your messaging layer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/app-devs/make-api-calls">Make Wallet API calls</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/app-devs/recommended-patterns">Recommended patterns</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Protocol Docs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/protocol-docs/wallet-devs-intro">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/protocol-docs/quick-start">Quick Start</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/protocol-docs/tutorial">Tutorial</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Protocol Tutorial</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/protocol-tutorial/execute-state-transitions">Execute state transitions off chain</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/protocol-tutorial/deposit-assets">Deposit Assets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/protocol-tutorial/finalize-a-channel-happy">Finalize a channel (happy)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/protocol-tutorial/finalize-a-channel-sad">Finalize a channel (sad)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/protocol-tutorial/understand-channel-storage">Understand channel storage</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/protocol-tutorial/clear-a-challenge">Clear a challenge</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/protocol-tutorial/outcomes">Understand Outcomes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/protocol-tutorial/release-assets">Release assets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/protocol-tutorial/off-chain-funding">Off-chain funding</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Implementation Notes</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/implementation-notes/contract-devs-intro">Introduction</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/implementation-notes/asset-holder">AssetHolder.sol</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/implementation-notes/force-move">ForceMove.sol</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/implementation-notes/nitro-adjudicator">NitroAdjudicator.sol</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/implementation-notes/null-app">Null app</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/implementation-notes/single-asset-payments">SingleAssetPayments.sol</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">AssetHolder.sol</h1></header><div class="markdown"><p>The asset-holder contracts describe how ETH and/or tokens are held on-chain for any given channel, and how to interpret the channel outcomes in order to determine and execute any payouts that are due.</p><p>AssetHolder.sol is a base contract that it is not actually deployed. It is inherited by (for example) ETHAssetHolder.sol and ERC20AssetHolder.sol (which are deployed).</p><p>In Nitro a payout is of one of two types: it is either a payout to a channel participant or it is a payout to another channel. It is this second type of payout that allows channels to fund one another in Nitro, enabling the virtual channels that are used to build state channel networks.</p><p>Nitro is implemented in <code>AssetHolder.sol</code>, which conforms to the <a href="/../contract-api/natspec/IAssetHolder"><code>IAssetHolder</code></a> interface and</p><ol><li>Interprets final outcomes supplied by adjudicator contracts</li><li>Allows escrowed assets to be transferred from channels to their beneficiaries</li></ol><p>This contract is only used as a base contract, and is extended by <code>ETHAssetHolder.sol</code> and <code>ERC20AssetHolder.sol</code> which additionally:</p><ol start="3"><li>Stipulate how assets are deposited and paid out to external destinations.</li></ol><hr><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="outcomes"></a>Outcomes<a aria-hidden="true" tabindex="-1" class="hash-link" href="#outcomes" title="Direct link to heading">#</a></h2><p>ForceMove specifies that a state should have a default <code>outcome</code> but does not specify the format of that <code>outcome</code>, and simply treats it as an unstructured <code>bytes</code> field. In this section we look at the outcome formats needed for Nitro.</p><p>Nitro supports multiple different assets (e.g. ETH and one or more ERC20s) being held in the same channel.</p><p>The outcome is stored in two places: first, as a single hash in the adjudicator contract; second, in multiple hashes across multiple asset holder contracts.</p><p>The adjudicator stores (the hash of) an encoded <code>outcome</code> for each finalized channel. As a part of the process triggered by <a href="/implementation-notes/nitro-adjudicator#push-outcome"><code>pushOutcome</code></a>, a decoded outcome will be stored across multiple asset holder contracts in a number of hashes. A decoded <code>outcome</code> is an array of <code>OutcomeItems</code>. These individual <code>OutcomeItems</code> contain a pointer to the asset holder contract in question, as well as some <code>bytes</code> that encode a <code>AssetOutcome</code>. The <code>AssetOutcomes</code> are each stored (abi encoded and hashed) by the asset holder contract specified. This data structure contains some more <code>bytes</code> encoding either an allocation or a guarantee, as well as the <code>AssetOutcomeType</code>: an integer which indicates which.</p><p>In <code>Outcome.sol</code>:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-solidity codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token plain">pragma solidity ^0.6.0;</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">pragma experimental ABIEncoderV2;</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">library Outcome {</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  // An outcome is an array of OutcomeItems</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  // Outcome = OutcomeItem[]</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  // OutcomeItem = (AssetHolderAddress, AssetOutcome)</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  // AssetOutcome = (AssetOutcomeType, Allocation | Guarantee)</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  // Allocation = AllocationItem[]</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  // AllocationItem = (Destination, Amount)</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  // Guarantee = (ChannelId, Destination[])</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  // Destination = ChannelId | ExternalDestination</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  struct OutcomeItem {</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    address assetHolderAddress;</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    bytes assetOutcomeBytes; // abi.encode(AssetOutcome)</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  }</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  enum AssetOutcomeType {Allocation, Guarantee}</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  struct AssetOutcome {</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    uint8 assetOutcomeType; // AssetOutcomeType.Allocation or AssetOutcomeType.Guarantee</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    bytes allocationOrGuaranteeBytes; // abi.encode(AllocationItem[]) or abi.encode(Guarantee), depending on OutcomeType</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  }</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  // reserve Allocation to refer to AllocationItem[]</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  struct AllocationItem {</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    bytes32 destination;</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    uint256 amount;</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  }</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  struct Guarantee {</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    bytes32 targetChannelId;</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    bytes32[] destinations;</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  }</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">}</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="destinations"></a>Destinations<a aria-hidden="true" tabindex="-1" class="hash-link" href="#destinations" title="Direct link to heading">#</a></h3><p>A <code>Destination</code> is a <code>bytes32</code> and either:</p><ol><li>A <code>ChannelId</code> (see the section on <a href="/implementation-notes/force-move#channelid">channelId</a>), or</li><li>An <code>ExternalDestination</code>, which is an ethereum address left-padded with zeros.</li></ol><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>In JavaScript, the <code>ExternalDestination</code> corresponding to <code>address</code> may be computed as</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token plain">&#x27;0x&#x27; + address.padStart(64, &#x27;0&#x27;)</span></div></div></div></div></div></div></div><hr><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="storage"></a>Storage<a aria-hidden="true" tabindex="-1" class="hash-link" href="#storage" title="Direct link to heading">#</a></h2><p>An AssetHolder will store the following information:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-solidity codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token plain">address AdjudicatorAddress; // used to apply permissions to certain methods</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">mapping(bytes32 =&gt; uint256) public holdings; // assets stored against channelIds</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">mapping(bytes32 =&gt; bytes32) public assetOutcomeHashes; // asset outcomes stored against channelIds</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="deposit"></a><code>deposit</code><a aria-hidden="true" tabindex="-1" class="hash-link" href="#deposit" title="Direct link to heading">#</a></h2><p>The deposit method allows ETH or ERC20 tokens to be escrowed against a channel.</p><p>Call signature:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-solidity codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token plain">function deposit(bytes32 destination, uint256 expectedHeld, uint256 amount) public payable</span></div></div></div></div></div><p>Checks:</p><ul><li><code>destination</code> must NOT be an <a href="#destinations">external destination</a>.</li><li>The holdings for <code>destination</code> must be greater than or equal to <code>expectedHeld</code>.</li><li>The holdings for <code>destination</code> must be less than the sum of the amount expected to be held and the amount declared in the deposit.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="ethassetholder-checks"></a><code>ETHAssetHolder</code> checks<a aria-hidden="true" tabindex="-1" class="hash-link" href="#ethassetholder-checks" title="Direct link to heading">#</a></h3><p>The transaction must be accompanied by exactly <code>amount</code> wei.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="erc20assetholder-checks"></a><code>ERC20AssetHolder</code> checks<a aria-hidden="true" tabindex="-1" class="hash-link" href="#erc20assetholder-checks" title="Direct link to heading">#</a></h3><p><code>ERC20AssetHolder.sol</code> includes an interface to a particular ERC20 Token with an address baked in at deploy-time.</p><p>This contract must be able to successfully call <code>transferFrom</code> on that ERC20 Token contract, with the Token account being <code>msg.sender</code> with a sufficient number of tokens specified.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-solidity codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token plain">// ...</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">  IERC20 Token;</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">//...</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">}</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">contract IERC20 {</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    // Abstraction of the parts of the ERC20 Interface that we need</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    function transfer(address to, uint256 tokens) public returns (bool success);</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    function transferFrom(address from, address to, uint256 tokens) public returns (bool success);</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">}</span></div><div class="token-line" style="color:#ffffff"><span class="token plain" style="display:inline-block">
</span></div></div></div></div></div><p>Effects:</p><p>Increase holdings for <code>destination</code> to the sum of the amount expected to be held and the amount declared in the deposit.</p><p>Emit a <code>Deposited</code> event with <code>indexed</code> parameter <code>destination</code>.</p><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>warning</h5></div><div class="admonition-content"><p>You may only deposit to a channel address. This is currently enforced at the contract level, but this may change in future. Do not attempt to deposit into external destinations.</p></div></div><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</h5></div><div class="admonition-content"><p>Depositing ahead of those with higher precedence is not safe (they can steal your funds). Always ensure that the channel is funded up to and including all players with higher precedence, before making a deposit.</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="setassetoutcomehash"></a><code>setAssetOutcomeHash</code><a aria-hidden="true" tabindex="-1" class="hash-link" href="#setassetoutcomehash" title="Direct link to heading">#</a></h2><p>The <code>setAssetOutcomeHash</code> method allows an outcome (more strictly, an <code>outcomeHash</code>) to be registered against a channel.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-solidity codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token plain">    function setAssetOutcomeHash(bytes32 channelId, bytes32 assetOutcomeHash)</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">        external</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">        AdjudicatorOnly</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">        returns (bool success)</span></div></div></div></div></div><p>It may only be called by the Nitro Adjudicator.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="permissions"></a>Permissions<a aria-hidden="true" tabindex="-1" class="hash-link" href="#permissions" title="Direct link to heading">#</a></h3><p>The following function modifier restricts permission to a certain Adjudicator.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-solidity codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token plain">    modifier AdjudicatorOnly {</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">        require(msg.sender == AdjudicatorAddress, &#x27;Only the NitroAdjudicator is authorized&#x27;);</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">        _;</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    }</span></div></div></div></div></div><p>Checks:</p><ul><li>A single adjudicator address is baked into this contract at deploy-time</li><li>Is <code>msg.sender</code> equal to this address?</li></ul><p>Effects:</p><ul><li>store <code>assetOutcomeHash</code> against <code>channelId</code>.</li></ul><hr><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="transferall"></a><code>transferAll</code><a aria-hidden="true" tabindex="-1" class="hash-link" href="#transferall" title="Direct link to heading">#</a></h2><p>The transferAll method takes the funds escrowed against a channel, and attempts to transfer them to the beneficiaries of that channel. The transfers are attempted in priority order, so that beneficiaries of underfunded channels may not receive a transfer, depending on their priority. Surplus funds remain in escrow against the channel. Full or partial transfers to a beneficiary results in deletion or reduction of that beneficiary&#x27;s allocation (respectively). A transfer to another channel results in explicit escrow of funds against that channel. A transfer to an external destination results in ETH or ERC20 tokens being transferred out of the AssetHolder contract.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-solidity codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token plain">function transferAll(bytes32 channelId, bytes calldata allocationBytes) external</span></div></div></div></div></div><p>This algorithm works by counting the number of <code>AllocationItems</code> that are to be completely converted into payouts. The remaining <code>AllocationItems</code> will be stored in a new <code>Allocation</code> and the storage mapping updated. There can be at most a single item that is a partial payout -- in this case the appropriately modified <code>AllocationItem</code> is also preserved. This is called the &#x27;overlap&#x27; case.</p><hr><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="claimall"></a><code>claimAll</code><a aria-hidden="true" tabindex="-1" class="hash-link" href="#claimall" title="Direct link to heading">#</a></h2><p>The claimAll method takes the funds escrowed against a guarantor channel, and attempts to transfer them to the beneficiaries of the target channel specified by the guarantor. The transfers are first attempted in a nonstandard priority order given by the guarantor, so that beneficiaries of underfunded channels may not receive a transfer, depending on their nonstandard priority. Full or partial transfers to a beneficiary results in deletion or reduction of that beneficiary&#x27;s allocation (respectively). Surplus funds are then subject to another attempt to transfer them to the beneficiaries of the target channel, but this time with the standard priority order given by the target channel. Any funds that still remain after this step remain in escrow against the guarantor.</p><p>As with <code>transferAll</code>, a transfer to another channel results in explicit escrow of funds against that channel. A transfer to an external destination results in ETH or ERC20 tokens being transferred out of the AssetHolder contract.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-solidity codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token plain">   function claimAll(</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">        bytes32 channelId,</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">        bytes calldata guaranteeBytes,</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">        bytes calldata allocationBytes</span></div><div class="token-line" style="color:#ffffff"><span class="token plain">    ) external</span></div></div></div></div></div><p>In comparison to <code>transferAll</code>, in <code>claimAll</code> it is more difficult to track the unknown number of payouts and new <code>AllocationItems</code>. An array of payouts is initialized with the same length as the target channel&#x27;s allocation. While the balance is positive, and for each destination in the guarantee, find the first occurrence of that destination in the target channel&#x27;s allocation. If there is sufficient balance remaining, increase the payout and decrease the number of new allocation items. If there is insufficient balance remaining, assign all of it to a payout (and the balance becomes zero), decrease the amount in the allocation item, and do not decrease the number of new allocation items. With the remaining balance (if any) continue thus: While the balance remains positive, and for each item in the target channel&#x27;s allocation, if there is sufficient balance remaining, increase the payout and decrease the number of new allocation items. If there is insufficient balance remaining, assign all of it to a payout (and the balance becomes zero), decrease the amount in the allocation item, and do not decrease the number of new allocation items.</p><p>Finally, update the holdings, compute the new allocation and update the storage, and execute the payouts.</p><hr><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="_transferasset"></a><code>_transferAsset</code><a aria-hidden="true" tabindex="-1" class="hash-link" href="#_transferasset" title="Direct link to heading">#</a></h2><p>This internal method executes transfers of assets external to the Nitro network.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-solidity codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#282c34;color:#ffffff"><div class="token-line" style="color:#ffffff"><span class="token plain">function _transferAsset(address payable destination, uint256 amount) internal {}</span></div></div></div></div></div><p>The behavior is slightly different depending on the asset that has been escrowed:</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="ethassetholder-transfer"></a><code>ETHAssetHolder</code> transfer<a aria-hidden="true" tabindex="-1" class="hash-link" href="#ethassetholder-transfer" title="Direct link to heading">#</a></h3><p>Executes an ethereum <code>transfer</code> of <code>amount</code> to <code>destination</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="erc20assetholder-transfer"></a><code>ERC20AssetHolder</code> transfer<a aria-hidden="true" tabindex="-1" class="hash-link" href="#erc20assetholder-transfer" title="Direct link to heading">#</a></h3><p>Calls <code>transfer(destination,amount)</code> on the specified Token contract.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"></div><div class="col text--right"><em><small>Last updated on <time datetime="2020-09-14T23:28:53.000Z" class="docLastUpdatedAt_217_">9/14/2020</time> by <strong>Caleb Ditchfield</strong></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/implementation-notes/contract-devs-intro"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Introduction</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/implementation-notes/force-move"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ForceMove.sol Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3klQ"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#outcomes" class="table-of-contents__link">Outcomes</a><ul><li><a href="#destinations" class="table-of-contents__link">Destinations</a></li></ul></li><li><a href="#storage" class="table-of-contents__link">Storage</a></li><li><a href="#deposit" class="table-of-contents__link"><code>deposit</code></a><ul><li><a href="#ethassetholder-checks" class="table-of-contents__link"><code>ETHAssetHolder</code> checks</a></li><li><a href="#erc20assetholder-checks" class="table-of-contents__link"><code>ERC20AssetHolder</code> checks</a></li></ul></li><li><a href="#setassetoutcomehash" class="table-of-contents__link"><code>setAssetOutcomeHash</code></a><ul><li><a href="#permissions" class="table-of-contents__link">Permissions</a></li></ul></li><li><a href="#transferall" class="table-of-contents__link"><code>transferAll</code></a></li><li><a href="#claimall" class="table-of-contents__link"><code>claimAll</code></a></li><li><a href="#_transferasset" class="table-of-contents__link"><code>_transferAsset</code></a><ul><li><a href="#ethassetholder-transfer" class="table-of-contents__link"><code>ETHAssetHolder</code> transfer</a></li><li><a href="#erc20assetholder-transfer" class="table-of-contents__link"><code>ERC20AssetHolder</code> transfer</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="text--center"><div class="margin-bottom--sm"><img class="footer__logo" src="/img/logo.svg"></div><div>Copyright Â© 2020</div></div></div></footer></div>
<script src="/styles.8e0db825.js"></script>
<script src="/runtime~main.27671965.js"></script>
<script src="/main.03452097.js"></script>
<script src="/2.4ee922d7.js"></script>
<script src="/3.4c7fc1f6.js"></script>
<script src="/4.a5988223.js"></script>
<script src="/1be78505.75ec5049.js"></script>
<script src="/369.23cc9095.js"></script>
<script src="/ec1ed54d.db84b9ba.js"></script>
<script src="/17896441.61fde53e.js"></script>
<script src="/69846863.53cf0c25.js"></script>
</body>
</html>